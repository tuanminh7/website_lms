{% extends "base.html" %}

{% block title %}Th√™m t√†i li·ªáu - H·ªçc Tin THPT{% endblock %}

{% block content %}
<div class="container">
    <h1>Th√™m t√†i li·ªáu m·ªõi</h1>
    <p class="subtitle">Th√™m video YouTube ho·∫∑c t√†i li·ªáu Google Drive</p>

    <form id="addDocumentForm">
        <div class="form-group">
            <label for="docTitle">Ti√™u ƒë·ªÅ t√†i li·ªáu: <span class="required">*</span></label>
            <input type="text" id="docTitle" placeholder="VD: Gi·ªõi thi·ªáu Python c∆° b·∫£n" required>
        </div>

        <div class="form-group">
            <label for="docUrl">Link t√†i li·ªáu: <span class="required">*</span></label>
            <input type="url" id="docUrl" placeholder="https://youtube.com/... ho·∫∑c https://drive.google.com/..." required>
            <small class="form-hint">H·ªó tr·ª£: YouTube, Google Drive, ho·∫∑c link tr·ª±c ti·∫øp</small>
        </div>

        <div class="form-group">
            <label for="docType">Lo·∫°i t√†i li·ªáu:</label>
            <select id="docType">
                <option value="auto">T·ª± ƒë·ªông nh·∫≠n di·ªán</option>
                <option value="youtube">Video YouTube</option>
                <option value="drive">Google Drive</option>
                <option value="pdf">File PDF</option>
                <option value="other">Kh√°c</option>
            </select>
        </div>

        <div class="form-group">
            <label for="docDescription">M√¥ t·∫£:</label>
            <textarea id="docDescription" rows="4" placeholder="M√¥ t·∫£ ng·∫Øn g·ªçn v·ªÅ n·ªôi dung t√†i li·ªáu..."></textarea>
        </div>

        <div class="form-group">
            <label for="docCategory">Ch·ªß ƒë·ªÅ:</label>
            <select id="docCategory">
                <option value="">Ch·ªçn ch·ªß ƒë·ªÅ</option>
                <option value="python">Python</option>
                <option value="algorithm">Thu·∫≠t to√°n</option>
                <option value="data-structure">C·∫•u tr√∫c d·ªØ li·ªáu</option>
                <option value="oop">L·∫≠p tr√¨nh h∆∞·ªõng ƒë·ªëi t∆∞·ª£ng</option>
                <option value="web">L·∫≠p tr√¨nh Web</option>
                <option value="database">C∆° s·ªü d·ªØ li·ªáu</option>
                <option value="other">Kh√°c</option>
            </select>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-primary">‚úì Th√™m t√†i li·ªáu</button>
            <a href="{{ url_for('documents') }}" class="btn btn-secondary">‚Üê H·ªßy</a>
        </div>
    </form>

    <div class="preview-section" id="previewSection" style="display: none;">
        <h3>Xem tr∆∞·ªõc:</h3>
        <div id="previewContent"></div>
    </div>
</div>

<script>
const urlInput = document.getElementById('docUrl');
const typeSelect = document.getElementById('docType');
const previewSection = document.getElementById('previewSection');
const previewContent = document.getElementById('previewContent');

urlInput.addEventListener('input', function() {
    const url = this.value.trim();
    
    if (url.includes('youtube.com') || url.includes('youtu.be')) {
        typeSelect.value = 'youtube';
        showPreview(url, 'youtube');
    } else if (url.includes('drive.google.com')) {
        typeSelect.value = 'drive';
        showPreview(url, 'drive');
    } else {
        previewSection.style.display = 'none';
    }
});

function showPreview(url, type) {
    previewSection.style.display = 'block';
    
    if (type === 'youtube') {
        let videoId = '';
        if (url.includes('youtube.com')) {
            const urlParams = new URLSearchParams(new URL(url).search);
            videoId = urlParams.get('v');
        } else if (url.includes('youtu.be')) {
            videoId = url.split('youtu.be/')[1].split('?')[0];
        }
        
        if (videoId) {
            previewContent.innerHTML = `
                <iframe width="100%" height="315" 
                    src="https://www.youtube.com/embed/${videoId}" 
                    frameborder="0" allowfullscreen>
                </iframe>
            `;
        }
    } else if (type === 'drive') {
        previewContent.innerHTML = `
            <div class="drive-preview">
                <p>üìÅ Google Drive: ${url}</p>
                <small>Link s·∫Ω ƒë∆∞·ª£c l∆∞u ƒë·ªÉ h·ªçc sinh t·∫£i v·ªÅ</small>
            </div>
        `;
    }
}

document.getElementById('addDocumentForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const title = document.getElementById('docTitle').value.trim();
    const url = document.getElementById('docUrl').value.trim();
    const type = document.getElementById('docType').value;
    const description = document.getElementById('docDescription').value.trim();
    const category = document.getElementById('docCategory').value;
    
    if (!title || !url) {
        alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß ti√™u ƒë·ªÅ v√† link!');
        return;
    }
    
    const data = {
        title: title,
        url: url,
        type: type === 'auto' ? detectType(url) : type,
        description: description,
        category: category
    };
    
    try {
        const response = await fetch('/teacher/add_document', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('‚úì Th√™m t√†i li·ªáu th√†nh c√¥ng!');
            window.location.href = '/documents';
        } else {
            alert('‚úó L·ªói: ' + result.message);
        }
    } catch (error) {
        alert('‚úó C√≥ l·ªói x·∫£y ra: ' + error.message);
        console.error(error);
    }
});

function detectType(url) {
    if (url.includes('youtube.com') || url.includes('youtu.be')) {
        return 'youtube';
    } else if (url.includes('drive.google.com')) {
        return 'drive';
    } else if (url.endsWith('.pdf')) {
        return 'pdf';
    }
    return 'other';
}
</script>

<style>
.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #333;
}

.required {
    color: red;
}

.form-group input,
.form-group select,
.form-group textarea {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 14px;
}

.form-group input:focus,
.form-group textarea:focus,
.form-group select:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
}

.form-hint {
    display: block;
    margin-top: 5px;
    font-size: 12px;
    color: #666;
}

.form-actions {
    display: flex;
    gap: 10px;
    margin-top: 30px;
}

.preview-section {
    margin-top: 30px;
    padding: 20px;
    background-color: #f9f9f9;
    border-radius: 8px;
}

.preview-section h3 {
    margin-top: 0;
    margin-bottom: 15px;
}

.drive-preview {
    padding: 15px;
    background-color: white;
    border: 1px solid #ddd;
    border-radius: 4px;
}

.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    text-decoration: none;
    display: inline-block;
}

.btn-primary {
    background-color: #007bff;
    color: white;
}

.btn-primary:hover {
    background-color: #0056b3;
}

.btn-secondary {
    background-color: #6c757d;
    color: white;
}

.btn-secondary:hover {
    background-color: #545b62;
}
</style>
{% endblock %}